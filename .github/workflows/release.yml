name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-desktop:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.optional }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: macos
            optional: false
            bundle: dmg
            artifact_glob: src-tauri/target/release/bundle/dmg/*.dmg
          - os: windows-latest
            platform: windows
            optional: false
            bundle: nsis
            artifact_glob: src-tauri/target/release/bundle/nsis/*.exe
          - os: ubuntu-latest
            platform: linux
            optional: true
            bundle: appimage
            artifact_glob: src-tauri/target/release/bundle/appimage/*.AppImage

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - uses: dtolnay/rust-toolchain@stable

      - name: Install Linux deps
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf || \
          sudo apt-get install -y libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend deps
        run: npm ci --prefix frontend

      - name: Build desktop app
        run: npx @tauri-apps/cli@1.5.14 build --bundles ${{ matrix.bundle }}

      - name: Upload desktop artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.platform }}
          path: ${{ matrix.artifact_glob }}
          if-no-files-found: ${{ matrix.optional && 'warn' || 'error' }}

  package-extensions:
    name: Package Extensions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build extension zips
        run: |
          mkdir -p release-assets
          cp -R extension release-assets/chrome
          cp -R extension release-assets/firefox
          cp -R extension release-assets/safari

          python - <<'PY'
          import json
          from pathlib import Path

          firefox_manifest = Path("release-assets/firefox/manifest.json")
          fm = json.loads(firefox_manifest.read_text())
          fm["browser_specific_settings"] = {"gecko": {"id": "safenode@safenode.app", "strict_min_version": "109.0"}}
          fm["background"] = {"scripts": ["background.js"]}
          fm.pop("web_accessible_resources", None)
          firefox_manifest.write_text(json.dumps(fm, indent=2) + "\n")

          safari_manifest = Path("release-assets/safari/manifest.json")
          sm = json.loads(safari_manifest.read_text())
          sm["name"] = "SafeNode Password Manager (Safari)"
          sm.pop("web_accessible_resources", None)
          safari_manifest.write_text(json.dumps(sm, indent=2) + "\n")
          PY

          cd release-assets/chrome && zip -rq ../safenode-extension-chrome.zip . && cd ../..
          cd release-assets/firefox && zip -rq ../safenode-extension-firefox.zip . && cd ../..
          cd release-assets/safari && zip -rq ../safenode-extension-safari.zip . && cd ../..
          rm -rf release-assets/chrome release-assets/firefox release-assets/safari

      - name: Upload extension artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extensions
          path: |
            release-assets/safenode-extension-chrome.zip
            release-assets/safenode-extension-firefox.zip
            release-assets/safenode-extension-safari.zip
          if-no-files-found: error

  publish-release:
    name: Publish Release Assets
    runs-on: ubuntu-latest
    needs:
      - build-desktop
      - package-extensions
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Normalize filenames
        run: |
          mkdir -p release-assets

          MAC_FILE="$(find artifacts/desktop-macos -type f -name '*.dmg' | head -n 1 || true)"
          WIN_FILE="$(find artifacts/desktop-windows -type f -name '*.exe' | head -n 1 || true)"
          LINUX_FILE="$(find artifacts/desktop-linux -type f -name '*.AppImage' | head -n 1 || true)"

          if [ -z "${MAC_FILE}" ]; then
            echo "Missing macOS artifact"
            exit 1
          fi
          if [ -z "${WIN_FILE}" ]; then
            echo "Missing Windows artifact"
            exit 1
          fi

          cp "${MAC_FILE}" release-assets/SafeNode-macOS.dmg
          cp "${WIN_FILE}" release-assets/SafeNode-Windows.exe
          if [ -n "${LINUX_FILE}" ]; then
            cp "${LINUX_FILE}" release-assets/SafeNode-Linux.AppImage
          fi

          cp artifacts/extensions/safenode-extension-chrome.zip release-assets/safenode-extension-chrome.zip
          cp artifacts/extensions/safenode-extension-firefox.zip release-assets/safenode-extension-firefox.zip
          cp artifacts/extensions/safenode-extension-safari.zip release-assets/safenode-extension-safari.zip

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
