name: Deploy Backend to Railway

# Trigger on push to main/production branches or manual dispatch
# Only runs when backend code or workflow file changes
on:
  push:
    branches:
      - main
      - production
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch: # Allows manual triggering from GitHub UI

jobs:
  deploy:
    name: Deploy SafeNode Backend to Railway
    runs-on: ubuntu-latest
    # environment: production # Uncomment if you've created a GitHub environment named "production"
    
    steps:
      # Step 1: Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # Shallow clone for faster checkout

      # Step 2: Setup Node.js 20 with npm caching
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      # Step 3: Install dependencies with npm ci (clean install)
      # npm ci is faster and more reliable than npm install for CI/CD
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
        env:
          # Prisma needs DATABASE_URL even for generate (can be dummy in CI)
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://dummy:dummy@localhost:5432/dummy' }}

      # Step 4: Generate Prisma Client
      # Must run before build since TypeScript depends on generated types
      - name: Generate Prisma Client
        working-directory: ./backend
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://dummy:dummy@localhost:5432/dummy' }}

      # Step 5: Build TypeScript to JavaScript
      - name: Build application
        working-directory: ./backend
        run: npm run build

      # Step 6: Deploy to Railway using official action
      # This uploads the built code and triggers Railway deployment
      - name: Deploy to Railway
        uses: railwayapp/deploy-action@v1
        with:
          # Railway API token (get from Railway dashboard ‚Üí Account ‚Üí Tokens)
          token: ${{ secrets.RAILWAY_TOKEN }}
          # Railway project ID (get from Railway project settings)
          projectId: ${{ secrets.RAILWAY_PROJECT_ID }}
          # Service name in Railway (must match your service name)
          service: backend
          # Path to the directory to deploy (backend folder)
          path: ./backend
          # Environment to deploy to (optional, defaults to production)
          environment: production

      # Step 7: Wait for Railway deployment to complete
      # Railway deployments are async, so we wait a bit for the service to start
      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for Railway deployment to complete..."
          sleep 15
          echo "‚úÖ Deployment wait complete"

      # Step 8: Run database migrations AFTER deployment
      # CRITICAL: Migrations must run AFTER the new code is deployed
      # This ensures the new code can handle the migrated schema
      # Uses Railway CLI to run migrations inside the Railway environment
      - name: Run database migrations
        working-directory: ./backend
        run: |
          echo "üîÑ Installing Railway CLI..."
          npm install -g @railway/cli
          
          echo "üîÑ Authenticating Railway CLI..."
          railway login --token "$RAILWAY_TOKEN"
          
          echo "üîÑ Linking to Railway project..."
          railway link --project "$RAILWAY_PROJECT_ID"
          
          echo "üîÑ Running database migrations via Railway..."
          railway run --service backend npx prisma migrate deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        continue-on-error: false # Fail if migrations fail

      # Step 9: Health check with retry loop (up to 4 minutes)
      # Verifies the deployed service is actually running and responding
      - name: Health check with retry
        run: |
          echo "üè• Starting health check..."
          MAX_ATTEMPTS=24  # 24 attempts √ó 10 seconds = 4 minutes max
          ATTEMPT=1
          HEALTH_URL="https://${{ secrets.RAILWAY_PUBLIC_DOMAIN }}/api/health"
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Checking $HEALTH_URL"
            
            # Use curl with timeout and follow redirects
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 10 \
              --connect-timeout 5 \
              "$HEALTH_URL" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Health check passed! Service is responding."
              exit 0
            else
              echo "‚ùå Health check failed (HTTP $HTTP_CODE). Retrying in 10 seconds..."
              sleep 10
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done
          
          echo "‚ùå Health check failed after $MAX_ATTEMPTS attempts. Service may not be running."
          exit 1

      # Step 10: Optional - Seed database (only on first deploy)
      # Uncomment this step if you want to seed the database on first deployment
      # The seed script should be idempotent (safe to run multiple times)
      # - name: Seed database (first deploy only)
      #   working-directory: ./backend
      #   run: |
      #     echo "üå± Seeding database..."
      #     npm run db:seed || echo "‚ö†Ô∏è Seed script failed or already seeded (this is OK)"
      #   env:
      #     DATABASE_URL: ${{ secrets.DATABASE_URL }}
      #   continue-on-error: true # Don't fail deployment if seeding fails

      # Step 11: Deployment summary
      - name: Deployment summary
        if: success()
        run: |
          echo "üéâ Deployment successful!"
          echo "üìç Service URL: https://${{ secrets.RAILWAY_PUBLIC_DOMAIN }}"
          echo "üè• Health check: https://${{ secrets.RAILWAY_PUBLIC_DOMAIN }}/api/health"
          echo "üìö API docs: https://${{ secrets.RAILWAY_PUBLIC_DOMAIN }}/docs"
